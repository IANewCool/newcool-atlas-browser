name: Build NewCool Atlas Android (ARM32)

on:
  workflow_dispatch:

env:
  CHROMIUM_VERSION: "145.0.7560.0"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 1: PREPARACIรN
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ฅ Checkout patches"
        uses: actions/checkout@v4

      - name: "๐ [1/8] Espacio inicial"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 1: PREPARACIรN"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          df -h /

      - name: "๐งน [2/8] Liberar espacio en disco"
        run: |
          echo "Eliminando paquetes innecesarios..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup
          sudo docker image prune --all --force 2>/dev/null || true
          sudo apt-get clean
          echo "Espacio despuรฉs de limpieza:"
          df -h /

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 2: OBTENER CHROMIUM
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ฅ [3/8] Instalar depot_tools"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 2: OBTENER CHROMIUM"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$PWD/depot_tools" >> $GITHUB_PATH

      - name: "๐ฅ [4/8] Descargar Chromium"
        run: |
          mkdir chromium && cd chromium

          cat > .gclient << 'GCLIENT'
          solutions = [{
            "name": "src",
            "url": "https://chromium.googlesource.com/chromium/src.git@${{ env.CHROMIUM_VERSION }}",
            "managed": False,
            "custom_vars": {
              "checkout_android": True,
            },
          }]
          target_os = ["android"]
          GCLIENT

          echo "Iniciando descarga..."
          gclient sync --no-history --nohooks -j4 2>&1 | tail -20

          echo "โ Descarga completada"
          df -h /
        timeout-minutes: 90

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 3: CONFIGURAR BUILD
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ง [5/8] Instalar dependencias Android"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 3: CONFIGURAR BUILD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          cd chromium/src

          sudo ./build/install-build-deps.sh --android --no-prompt 2>&1 | tail -20 || true
          gclient runhooks 2>&1 | tail -10

          echo "โ Dependencias instaladas"

      - name: "๐ [6/8] Aplicar patches NewCool"
        run: |
          cd chromium/src

          echo "Aplicando patches..."
          for patch in $GITHUB_WORKSPACE/patches/*.patch; do
            name=$(basename "$patch")
            echo "โ $name"
            if git apply --check "$patch" 2>/dev/null; then
              git apply "$patch"
              echo "  โ Aplicado"
            else
              echo "  โ๏ธ Aplicando con merge..."
              git apply --3way "$patch" 2>/dev/null || echo "  โ Fallรณ: $name"
            fi
          done

          echo ""
          echo "Verificando branding:"
          head -5 chrome/app/theme/chromium/BRANDING

      - name: "โ๏ธ Configurar GN (ARM32)"
        run: |
          cd chromium/src

          gn gen out/Android-arm32 --args='
            target_os="android"
            target_cpu="arm"
            is_debug=false
            is_official_build=false
            is_component_build=false
            symbol_level=0
            enable_nacl=false
            blink_symbol_level=0
            v8_symbol_level=0
            chrome_pgo_phase=0
            android_channel="stable"
          '

          echo "โ Build ARM32 configurado"
          df -h /

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 4: COMPILAR
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐จ [7/8] Compilar APK (ARM32)"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 4: COMPILAR ARM32"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          cd chromium/src

          autoninja -C out/Android-arm32 chrome_public_apk 2>&1 | while read line; do
            if echo "$line" | grep -qE '^\[[0-9]+/[0-9]+\]'; then
              current=$(echo "$line" | sed 's/\[\([0-9]*\).*/\1/')
              if [ $((current % 2000)) -eq 0 ]; then
                echo "$line"
              fi
            fi
          done

          echo "โ Compilaciรณn completada"
          ls -lah out/Android-arm32/apks/
        timeout-minutes: 350

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 5: EMPAQUETAR
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ฆ [8/8] Empaquetar APK"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 5: EMPAQUETAR"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

          cd chromium/src/out/Android-arm32/apks
          mv ChromePublic.apk NewCool-Atlas-${{ env.CHROMIUM_VERSION }}-arm32.apk

          ls -lah NewCool-Atlas-*.apk
          echo "โ APK ARM32 listo"

      - name: "๐ Subir APK"
        uses: actions/upload-artifact@v4
        with:
          name: NewCool-Atlas-Android-ARM32
          path: chromium/src/out/Android-arm32/apks/NewCool-Atlas-*.apk
          retention-days: 90

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # RESUMEN
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ Resumen"
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "         NEWCOOL ATLAS - BUILD ANDROID ARM32"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "  Versiรณn:       ${{ env.CHROMIUM_VERSION }}"
          echo "  Plataforma:    Android"
          echo "  Arquitectura:  ARM32 (armeabi-v7a)"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
