name: Build NewCool Atlas macOS (ARM64)

on:
  workflow_dispatch:

env:
  CHROMIUM_VERSION: "145.0.7560.0"

jobs:
  build:
    runs-on: macos-15  # Apple Silicon with SDK 15+
    timeout-minutes: 360

    steps:
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 1: PREPARACIรN
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ฅ Checkout patches"
        uses: actions/checkout@v4

      - name: "๐ [1/7] Info del sistema"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 1: PREPARACIรN"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          uname -m
          sysctl -n machdep.cpu.brand_string
          sw_vers
          df -h /

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 2: OBTENER CHROMIUM
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ฅ [2/7] Instalar depot_tools"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 2: OBTENER CHROMIUM"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          git clone --depth 1 https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$PWD/depot_tools" >> $GITHUB_PATH

      - name: "๐ฅ [3/7] Descargar Chromium"
        run: |
          mkdir chromium && cd chromium

          cat > .gclient << 'GCLIENT'
          solutions = [{
            "name": "src",
            "url": "https://chromium.googlesource.com/chromium/src.git@${{ env.CHROMIUM_VERSION }}",
            "managed": False,
            "custom_vars": {},
          }]
          target_os = ["mac"]
          GCLIENT

          echo "Iniciando descarga (esto toma 20-40 min)..."
          # Usar --shallow en lugar de --no-history para descargar todo lo necesario
          gclient sync --shallow --nohooks -j4

          # Verificar que src existe y tiene contenido
          if [ ! -d "src/chrome" ]; then
            echo "โ Error: Chromium no se descargรณ correctamente"
            ls -la src/ 2>/dev/null || echo "src/ no existe"
            exit 1
          fi

          echo "โ Descarga completada"
          echo "Archivos en src/chrome:"
          ls src/chrome/ | head -10
          df -h /
        timeout-minutes: 90

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 3: CONFIGURAR BUILD
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ง [4/7] Ejecutar hooks"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 3: CONFIGURAR BUILD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          cd chromium/src
          gclient runhooks 2>&1 | tail -10
          echo "โ Hooks completados"

      - name: "๐ [5/7] Aplicar patches NewCool"
        run: |
          cd chromium/src
          
          echo "Aplicando patches..."
          for patch in $GITHUB_WORKSPACE/patches/*.patch; do
            name=$(basename "$patch")
            echo "โ $name"
            if git apply --check "$patch" 2>/dev/null; then
              git apply "$patch"
              echo "  โ Aplicado"
            else
              echo "  โ๏ธ Aplicando con merge..."
              git apply --3way "$patch" 2>/dev/null || echo "  โ Fallรณ: $name"
            fi
          done
          
          echo ""
          echo "Verificando branding:"
          head -5 chrome/app/theme/chromium/BRANDING

      - name: "โ๏ธ [6/7] Configurar GN (ARM64)"
        run: |
          cd chromium/src
          
          gn gen out/arm64 --args='
            target_os="mac"
            target_cpu="arm64"
            is_debug=false
            is_official_build=false
            is_component_build=false
            symbol_level=0
            enable_nacl=false
            blink_symbol_level=0
            v8_symbol_level=0
            chrome_pgo_phase=0
          '
          
          echo "โ Build ARM64 configurado"

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 4: COMPILAR
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐จ [7/7] Compilar"
        run: |
          set -o pipefail
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 4: COMPILAR"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          cd chromium/src

          # Ejecutar autoninja con log completo y mostrar progreso
          autoninja -C out/arm64 chrome 2>&1 | tee /tmp/build.log | while read line; do
            if echo "$line" | grep -qE '^\[[0-9]+/[0-9]+\]'; then
              current=$(echo "$line" | sed 's/\[\([0-9]*\).*/\1/')
              if [ $((current % 2000)) -eq 0 ]; then
                echo "$line"
              fi
            elif echo "$line" | grep -qiE 'error|failed|fatal'; then
              echo "$line"
            fi
          done

          # Verificar si hay errores en el log
          if grep -qiE 'error:|FAILED:|fatal error' /tmp/build.log; then
            echo "โ Errores encontrados:"
            grep -iE 'error:|FAILED:|fatal error' /tmp/build.log | tail -20
            exit 1
          fi

          echo "โ Compilaciรณn completada"
          ls -lah "out/arm64/NewCool Atlas.app" 2>/dev/null || ls -lah out/arm64/Chromium.app
        timeout-minutes: 350

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # FASE 5: EMPAQUETAR
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ฆ Empaquetar DMG"
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "FASE 5: EMPAQUETAR"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          cd chromium/src/out/arm64
          
          # Firmar ad-hoc
          APP_NAME="NewCool Atlas.app"
          if [ ! -d "$APP_NAME" ]; then
            APP_NAME="Chromium.app"
          fi
          
          codesign --force --deep --sign - "$APP_NAME" || true
          
          # Crear DMG
          mkdir -p dmg-contents
          cp -R "$APP_NAME" dmg-contents/
          ln -s /Applications dmg-contents/Applications
          
          hdiutil create -volname "NewCool Atlas" \
            -srcfolder dmg-contents \
            -ov -format UDZO \
            "NewCool-Atlas-${{ env.CHROMIUM_VERSION }}-arm64.dmg"
          
          echo "โ DMG creado"
          ls -lah NewCool-Atlas-*.dmg

      - name: "๐ Subir DMG"
        uses: actions/upload-artifact@v4
        with:
          name: NewCool-Atlas-macOS-ARM64
          path: chromium/src/out/arm64/NewCool-Atlas-*.dmg
          retention-days: 90

      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      # RESUMEN
      # โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
      - name: "๐ Resumen"
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "         NEWCOOL ATLAS - BUILD macOS ARM64"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "  Versiรณn:       ${{ env.CHROMIUM_VERSION }}"
          echo "  Plataforma:    macOS"
          echo "  Arquitectura:  ARM64 (Apple Silicon)"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
